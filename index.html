<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Central de Comando - Leiria</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        body { margin: 0; display: flex; height: 100vh; background: #000; font-family: sans-serif; color: white; }
        #map { flex-grow: 1; }
        #panel { width: 350px; background: #111; border-left: 3px solid #d32f2f; display: flex; flex-direction: column; }
        header { background: #d32f2f; padding: 15px; font-weight: bold; text-align: center; }
        .log { flex-grow: 1; overflow-y: auto; padding: 10px; font-size: 0.8rem; }
        .vtr-entry { padding: 10px; border-bottom: 1px solid #333; cursor: pointer; transition: 0.2s; }
        .vtr-entry:hover { background: #222; }
        .rasto-line { stroke-dasharray: 4, 6; opacity: 0.5; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="panel">
        <header>CENTRAL LEIRIA - 193</header>
        <div style="padding: 10px; font-size: 0.7rem; color: #888;">Clique na viatura para seguir ou enviar mensagem</div>
        <div class="log" id="vtrList"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const firebaseConfig = { databaseURL: "https://TEU-PROJETO.firebaseio.com" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const map = L.map('map').setView([39.7618, -8.7951], 11);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        // Carregar Freguesias de Leiria (GeoJSON)
        fetch('freguesias_leiria.geojson').then(r => r.json()).then(g => {
            L.geoJSON(g, { style: { color: '#444', weight: 1.5, fillOpacity: 0.05 } }).addTo(map);
        });

        const vtrs = {}; const rastros = {}; const linhas = {};
        let seguindo = null;

        db.ref('operacionais').on('value', snap => {
            const data = snap.val();
            const list = document.getElementById('vtrList');
            list.innerHTML = "";

            for(let id in data) {
                const v = data[id];
                if(!v.lat) continue;

                // 1. Criar/Mover Marcador
                if(!vtrs[id]) {
                    vtrs[id] = L.marker([v.lat, v.lng], {
                        icon: L.divIcon({ html: `<div id="dot-${id}" style="background:${v.cor}; width:16px; height:16px; border-radius:50%; border:2px solid white; box-shadow: 0 0 15px ${v.cor};"></div>` })
                    }).addTo(map).bindTooltip(id, { permanent: true, direction: 'top' });
                    
                    vtrs[id].on('click', () => abrirMenuVtr(id));
                } else {
                    vtrs[id].setLatLng([v.lat, v.lng]);
                    document.getElementById(`dot-${id}`).style.background = v.cor;
                }

                // 2. Rasto de 10 minutos
                const agora = Date.now();
                if(!rastros[id]) rastros[id] = [];
                rastros[id].push({ lat: v.lat, lng: v.lng, ts: agora });
                rastros[id] = rastros[id].filter(p => p.ts > agora - 600000); // 10 min

                const coords = rastros[id].map(p => [p.lat, p.lng]);
                if(!linhas[id]) {
                    linhas[id] = L.polyline(coords, { color: v.cor, weight: 2, className: 'rasto-line' }).addTo(map);
                } else {
                    linhas[id].setLatLngs(coords);
                }

                // 3. Auto-Follow
                if(seguindo === id) {
                    let zoom = (v.status === 'CAMINHO') ? 14 : 17;
                    map.setView([v.lat, v.lng], zoom, { animate: true });
                }

                // 4. Lista Lateral
                list.innerHTML += `<div class="vtr-entry" onclick="seguindo='${id}'" style="border-left: 5px solid ${v.cor}">
                    <strong>${id}</strong> - ${v.status}<br>
                    <small>Visto há: ${Math.round((agora-v.ts)/1000)}s</small>
                </div>`;
            }
        });

        function abrirMenuVtr(id) {
            const acao = confirm(`Viatura: ${id}\n\n[OK] Seguir Viatura\n[Cancelar] Enviar Mensagem`);
            if(acao) {
                seguindo = id;
            } else {
                const msg = prompt("Mensagem para enviar à viatura:");
                if(msg) db.ref('mensagens/' + id).set({ texto: msg, lida: false, ts: Date.now() });
            }
        }

        db.ref('alertas').on('child_added', snap => {
            const a = snap.val();
            const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
            audio.play();
            alert(a.msg);
        });
    </script>
</body>
</html>
